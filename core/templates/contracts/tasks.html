{#
  tasks.html - 任务管理页 / Task Management Page
  
  项目任务的增删改查和状态管理：
  CRUD and status management for project tasks:
  
  Features / 功能:
  - 任务列表表格 (部门、负责人、排期、状态) / Task list table
  - 任务状态流转 (未开始→进行中→已完成/暂停) / Task status flow
  - 新增任务表单 / Add task form
  
  Task Status States / 任务状态:
  - 未开始 (Unstarted): 初始状态
  - 进行中 (In Progress): 已开始执行
  - 已完成 (Completed): 任务完成
  - 已暂停 (Paused): 暂时搁置
  - 待质检 (QC Pending): 等待质检
  
  Dependencies / 依赖:
  - base.html (父模板 / Parent template)
  
  Variables / 传入变量:
  - contract: 合同对象 / Contract object
  - tasks: 任务列表 / Task list
  - departments: 部门列表 / Department list
  - persons: 人员列表 / Person list
#}
{% extends 'base.html' %}

{% block title %}任务与进度 - {{ contract.project_code }}{% endblock %}

{% block content %}
<div class="glass-panel" style="padding: 24px; border-radius: 12px; margin-bottom: 24px;">
    {# 项目头部信息 / Project header info #}
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <div style="font-size: 0.9rem; color: var(--color-text-sub);">项目编号: <span style="color: var(--color-primary); font-family: monospace;">{{ contract.project_code }}</span></div>
            <h2 style="margin: 4px 0 0 0; font-size: 1.5rem; font-weight: 700;">{{ contract.name }} - 任务管理</h2>
        </div>
        <a href="{{ url_for('contracts.list_contracts') }}" class="btn-industrial" style="background: transparent; border: 1px solid rgba(255,255,255,0.2);">返回列表</a>
    </div>

    {# 功能标签页 / Tab navigation #}
    <div style="display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; padding: 12px 4px 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 5; margin-top: -12px;">
        <a href="{{ url_for('contracts.contract_overview', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">总览</a>
        <a href="{{ url_for('contracts.manage_tasks', contract_id=contract.id) }}" class="btn-industrial" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">任务/进度</a>
        <a href="{{ url_for('contracts.manage_sales', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">销售</a>
        <a href="{{ url_for('contracts.notify_contract', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">通知</a>
        <a href="{{ url_for('contracts.manage_leaders', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">负责人</a>
        <a href="{{ url_for('contracts.manage_procurements', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">采购</a>
        <a href="{{ url_for('contracts.manage_acceptances', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">验收</a>
        <a href="{{ url_for('contracts.manage_feedbacks', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">反馈</a>
        <a href="{{ url_for('contracts.manage_files', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">文件</a>
    </div>

    {# 双栏布局：左侧任务列表，右侧新增表单 / Two-column: task list left, add form right #}
    <div style="display: grid; grid-template-columns: 1fr 350px; gap: 24px;">
        {# 左栏：任务列表 / Left column: task list #}
        <div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0;">现有任务</h3>
                <div style="font-size: 0.85rem; color: var(--color-text-sub);">共 {{ tasks|length }} 项</div>
            </div>
            
            {% if tasks %}
            <div class="table-container">
                <table class="ind-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">部门 / 负责人</th>
                            <th style="width: 25%;">任务内容</th>
                            <th style="width: 20%;">排期</th>
                            <th style="width: 15%;">状态</th>
                            <th style="width: 25%; text-align: right;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for t in tasks %}
                        <tr>
                            <td>
                                <div style="font-weight: 500;">{{ t.department.name if t.department else '-' }}</div>
                                <div style="font-size: 0.8rem; color: var(--color-text-sub);">{{ t.person.name if t.person else '未指派' }}</div>
                            </td>
                            <td>
                                <div style="font-weight: 500;">{{ t.title }}</div>
                                {% if t.remarks %}
                                <div style="font-size: 0.8rem; color: var(--color-text-sub); margin-top: 4px;">{{ t.remarks }}</div>
                                {% endif %}
                            </td>
                            <td>
                                <div style="font-size: 0.85rem;">
                                    {% if t.start_date %}{{ t.start_date.strftime('%Y-%m-%d') }}{% endif %}
                                </div>
                                <div style="font-size: 0.85rem; color: var(--color-text-sub);">
                                    至 {% if t.end_date %}{{ t.end_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}
                                </div>
                            </td>
                            <td>
                                {% set status_class = 'status-badge' %}
                                {% if t.status == '未开始' %} 
                                    {% set status_class = 'status-badge unstarted' %}
                                {% elif t.status == '进行中' %}
                                    {% set status_class = 'status-badge production' %}
                                {% elif t.status == '已完成' %}
                                    {% set status_class = 'status-badge accepted' %}
                                {% elif t.status == '已暂停' %}
                                    {% set status_class = 'status-badge danger' %}
                                {% elif t.status == '待质检' %}
                                    {% set status_class = 'status-badge warning' %}
                                {% endif %}
                                <span class="{{ status_class }}">{{ t.status }}</span>
                            </td>
                            <td style="text-align: center;">
                                <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                                    {% if t.status != '进行中' and t.status != '已完成' %}
                                    <form method="post" action="{{ url_for('contracts.change_task_status', contract_id=contract.id, task_id=t.id) }}">
                                        <input type="hidden" name="action" value="start">
                                        <button type="submit" class="btn-text" style="color: var(--color-primary); background: transparent; border: none; cursor: pointer; font-size: 0.85rem;">开始</button>
                                    </form>
                                    {% endif %}
                                    
                                    {% if t.status == '进行中' %}
                                    <form method="post" action="{{ url_for('contracts.change_task_status', contract_id=contract.id, task_id=t.id) }}">
                                        <input type="hidden" name="action" value="complete">
                                        <button type="submit" class="btn-text" style="color: var(--color-accent); background: transparent; border: none; cursor: pointer; font-size: 0.85rem;">完成</button>
                                    </form>
                                    <form method="post" action="{{ url_for('contracts.change_task_status', contract_id=contract.id, task_id=t.id) }}">
                                        <input type="hidden" name="action" value="pause">
                                        <button type="submit" class="btn-text" style="color: var(--color-warning); background: transparent; border: none; cursor: pointer; font-size: 0.85rem;">暂停</button>
                                    </form>
                                    {% endif %}
                                    

                                    
                                    <form method="post" action="{{ url_for('contracts.delete_task', contract_id=contract.id, task_id=t.id) }}">
                                        <button type="submit" onclick="return confirm('确认删除该任务？');" class="btn-text" style="color: var(--color-danger); background: transparent; border: none; cursor: pointer; font-size: 0.85rem;">删除</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 48px; color: var(--color-text-sub); border: 1px dashed rgba(255,255,255,0.1); border-radius: 8px;">
                暂无任务，请在右侧添加。
            </div>
            {% endif %}
        </div>

        <!-- Right Column: Add Task Form -->
        <div class="glass-panel" style="padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); background: rgba(0,0,0,0.2); height: fit-content;">
            <h3 style="margin: 0 0 16px 0;">新增任务</h3>
            <form method="post">
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--color-text-sub); margin-bottom: 6px;">部门 <span style="color: var(--color-danger);">*</span></label>
                    <select name="department_id" class="form-control" style="width: 100%;" required>
                        <option value="">请选择部门</option>
                        {% for d in departments %}
                        <option value="{{ d.id }}">{{ d.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--color-text-sub); margin-bottom: 6px;">负责人</label>
                    <select name="person_id" class="form-control" style="width: 100%;">
                        <option value="">可不选 (待定)</option>
                        {% for p in persons %}
                        <option value="{{ p.id }}">{{ p.name }} - {{ p.position }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--color-text-sub); margin-bottom: 6px;">任务名称 <span style="color: var(--color-danger);">*</span></label>
                    <input type="text" name="title" class="form-control" style="width: 100%; box-sizing: border-box;" required>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--color-text-sub); margin-bottom: 6px;">开始日期 <span style="color: var(--color-danger);">*</span></label>
                    <input type="date" name="start_date" class="form-control" style="width: 100%; box-sizing: border-box;" required>
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--color-text-sub); margin-bottom: 6px;">完成日期 (可选)</label>
                    <input type="date" name="end_date" class="form-control" style="width: 100%; box-sizing: border-box;">
                </div>

                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; font-size: 0.85rem; color: var(--color-text-sub); margin-bottom: 6px;">备注 / 需求</label>
                    <textarea name="remarks" class="form-control" style="width: 100%; box-sizing: border-box;" rows="3"></textarea>
                </div>
                
                <div style="font-size: 0.8rem; color: var(--color-text-sub); margin-bottom: 16px;">
                    * 初始状态默认为“未开始”
                </div>

                <button type="submit" class="btn-industrial" style="width: 100%;">保存任务</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}
