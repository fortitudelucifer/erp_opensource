{#
  overview.html - 项目总览页 / Project Overview Page
  
  单个项目的详情总览页面，展示项目关键信息和甘特图：
  Overview page for a single project, displaying key info and Gantt chart:
  
  Sections / 功能区块:
  - 项目基本信息 / Project basic info
  - 功能标签页导航 / Tab navigation
  - 统计卡片 (交付日期、状态、任务数、负责人) / Stats cards
  - 甘特图 (Frappe Gantt) / Gantt chart
  
  Dependencies / 依赖:
  - base.html (父模板 / Parent template)
  - Frappe Gantt CDN (甘特图库 / Gantt chart library)
  
  Variables / 传入变量:
  - contract: 合同对象 / Contract object
  - status_text, status_level: 状态信息 / Status info
  - gantt_tasks: 甘特图任务数据 / Gantt task data
  - leaders, sales: 负责人和销售信息 / Leaders and sales info
#}
{% extends 'base.html' %}

{% block title %}项目总览 - {{ contract.name }}{% endblock %}

{% block content %}
<div class="glass-panel" style="padding: 24px; border-radius: 12px; margin-bottom: 24px;">
    {# 项目标题区域 / Project title area #}
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
        <div>
            <div style="font-size: 0.9rem; color: var(--color-text-sub); margin-bottom: 4px;">{{ contract.project_code }}</div>
            <h1 style="margin: 0; font-size: 1.75rem; font-weight: 700;">{{ contract.name }}</h1>
            <div style="margin-top: 8px; color: var(--color-text-main);">
                客户: {{ contract.company.name if contract.company else '-' }}
            </div>
        </div>
        </div>
        <div>
            <a href="{{ url_for('contracts.list_contracts') }}" class="btn-industrial" style="background: transparent; border: 1px solid rgba(255,255,255,0.2);">返回列表</a>
        </div>
    </div>

    {# 功能标签页导航 / Tab navigation #}
    <div style="display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; padding: 12px 4px 8px 4px; border-bottom: 1px solid rgba(255,255,255,0.1); position: relative; z-index: 5; margin-top: -12px;">
        <a href="{{ url_for('contracts.contract_overview', contract_id=contract.id) }}" class="btn-industrial" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">总览</a>
        <a href="{{ url_for('contracts.manage_tasks', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">任务/进度</a>
        <a href="{{ url_for('contracts.manage_sales', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">销售</a>
        <a href="{{ url_for('contracts.notify_contract', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">通知</a>
        <a href="{{ url_for('contracts.manage_leaders', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">负责人</a>
        <a href="{{ url_for('contracts.manage_procurements', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">采购</a>
        <a href="{{ url_for('contracts.manage_acceptances', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">验收</a>
        <a href="{{ url_for('contracts.manage_feedbacks', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">反馈</a>
        <a href="{{ url_for('contracts.manage_files', contract_id=contract.id) }}" class="btn-industrial" style="background: transparent; border: none; color: var(--color-text-sub);">文件</a>
    </div>

    {# 统计卡片行：显示关键指标 / Stats row: display key metrics #}
    <div class="bento-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 32px;">
        <div class="bento-item card">
            <div style="color: var(--color-text-sub); font-size: 0.85rem;">计划交付</div>
            <div style="font-size: 1.25rem; font-weight: 600; margin-top: 8px;">
                {{ contract.planned_delivery_date.strftime('%Y-%m-%d') if contract.planned_delivery_date else '未设定' }}
            </div>
        </div>
        <div class="bento-item card">
            <div style="color: var(--color-text-sub); font-size: 0.85rem;">当前状态</div>
            <div style="margin-top: 8px;">
                 <span class="status-badge {{ status_level }}">{{ status_text or '进行中' }}</span>
            </div>
        </div>
        <div class="bento-item card">
             <div style="color: var(--color-text-sub); font-size: 0.85rem;">任务数</div>
             <div style="font-size: 1.25rem; font-weight: 600; margin-top: 8px;">{{ gantt_tasks|length }}</div>
        </div>
        <div class="bento-item card">
             <div style="color: var(--color-text-sub); font-size: 0.85rem;">负责人 (我方)</div>
             <div style="font-size: 1.25rem; font-weight: 600; margin-top: 8px;">{{ contract.our_manager or '-' }}</div>
        </div>
    </div>

    <!-- Gantt Chart Section -->
    <div class="card" style="padding: 24px;">
        <h3 style="margin: 0 0 24px 0;">项目进度甘特图</h3>
        
        {% if gantt_tasks %}
            <div class="gantt-target" id="gantt-chart"></div>
        {% else %}
            <div style="text-align: center; padding: 48px; color: var(--color-text-sub); background: rgba(255,255,255,0.02); border-radius: 8px;">
                暂无排期任务，请前往 <a href="{{ url_for('contracts.manage_tasks', contract_id=contract.id) }}" style="color: var(--color-primary);">任务管理</a> 添加。
            </div>
        {% endif %}
    </div>
</div>

<!-- Frappe Gantt via CDN -->
<script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.1/dist/frappe-gantt.min.css">

<style>
    /* Custom Override for Dark Theme Gantt */
    .gantt .grid-header, .gantt .grid-row {
        fill: transparent;
        stroke: rgba(255,255,255,0.1);
    }
    .gantt .grid-row:nth-child(even) {
        fill: rgba(255,255,255,0.02);
    }
    .gantt .ticket {
        stroke: none;
    }
    /* Simple SVG text styling attempt */
    .gantt text {
        fill: #cbd5e1 !important; 
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tasksData = {{ gantt_tasks|default([])|tojson }};
        if (tasksData.length > 0) {
            const gantt = new Gantt("#gantt-chart", tasksData, {
                header_height: 50,
                column_width: 30,
                step: 24,
                view_modes: ['Quarter Day', 'Half Day', 'Day', 'Week', 'Month'],
                bar_height: 20,
                bar_corner_radius: 3,
                arrow_curve: 5,
                padding: 18,
                view_mode: 'Day',
                date_format: 'YYYY-MM-DD',
                custom_popup_html: function(task) {
                    return `
                        <div style="padding: 12px; background: #1e293b; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); color: #fff; width: 200px;">
                            <div style="font-weight: bold; margin-bottom: 4px;">${task.name}</div>
                            <div style="font-size: 0.85rem; color: #94a3b8;">${task.start} - ${task.end}</div>
                            <div style="font-size: 0.85rem; color: #94a3b8; margin-top: 4px;">进度: ${task.progress}%</div>
                        </div>
                    `;
                }
            });
            // dark mode adjustment
            gantt.change_view_mode('Week');
        }
    });
</script>
{% endblock %}
